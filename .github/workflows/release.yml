---
name: "daily-tagged-and-release"

on:
  schedule:
    - cron: '0 0 * * *'   # UTC 00:00

jobs:
  Auto-Tag:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      - name: Fetch all tags
        run: git fetch --tags

      - name: Calculate next version
        id: version
        run: |
          # 找到最新 v* tag，没有就从 v0.0.0 开始
          latest=$(git tag -l 'v*' --sort=-v:refname | head -n 1)
          echo "Latest tag: $latest"

          if [ -z "$latest" ]; then
            next="v0.0.1"
          else
            ver=${latest#v}
            IFS='.' read -r major minor patch <<< "$ver"
            next="v$major.$minor.$((patch + 1))"
          fi

          echo "Next tag: $next"
          echo "next=$next" >> $GITHUB_OUTPUT

      - name: Create and push tag
        run: |
          git tag ${{ steps.version.outputs.next }}
          git push origin ${{ steps.version.outputs.next }}
